<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏° - ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <a href="dashboard.html" class="navbar-brand">üîß ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
            <div class="navbar-menu">
                <a href="dashboard.html">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <a href="repair-requests.html">‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
                <a href="equipment.html">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</a>
                <a href="profile.html">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
                <span id="userName" style="color: #64748b;"></span>
                <button id="logoutBtn" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-between align-center">
                    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
                    <a href="create-request.html" class="btn btn-primary">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</a>
                </div>
            </div>

            <!-- Filters -->
            <div class="d-flex gap-2 mb-3" style="flex-wrap: wrap;">
                <input type="text" id="searchInput" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="max-width: 300px;">
                
                <select id="statusFilter" class="form-control" style="max-width: 200px;">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                    <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                    <option value="assigned">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
                    <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                    <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                    <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                </select>

                <select id="priorityFilter" class="form-control" style="max-width: 200px;">
                    <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
                    <option value="low">‡∏ï‡πà‡∏≥</option>
                    <option value="medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                    <option value="high">‡∏™‡∏π‡∏á</option>
                    <option value="urgent">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</option>
                </select>

                <button id="filterBtn" class="btn btn-secondary">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                <button id="resetBtn" class="btn btn-secondary">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <!-- Requests Table -->
            <div id="requestsContainer"></div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="modal-close" id="closeModal">&times;</span>
            <div class="modal-header">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="closeStatusModal">&times;</span>
            <div class="modal-header">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div id="statusModalContent">
                <form id="statusForm">
                    <input type="hidden" id="updateRequestId">
                    
                    <div class="form-group">
                        <label for="newStatus" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</label>
                        <select id="newStatus" class="form-control" required>
                            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                            <option value="assigned">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
                            <option value="in_progress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                            <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                            <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="statusComment" class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</label>
                        <textarea id="statusComment" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button type="button" class="btn btn-secondary" id="cancelStatusBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        // Check authentication
        requireAuth();

        let currentRequests = [];
        let userProfile = null;

        // Load user profile
        async function loadProfile() {
            try {
                const profile = await authAPI.getProfile();
                userProfile = profile;
                localStorage.setItem('profile', JSON.stringify(profile));
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Load repair requests
        async function loadRequests(filters = {}) {
            try {
                const loading = document.getElementById('loading');
                loading.classList.add('active');

                const response = await repairAPI.getAll(filters);
                currentRequests = response.results || response;

                displayRequests(currentRequests);
                loading.classList.remove('active');
            } catch (error) {
                console.error('Error loading requests:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
                document.getElementById('loading').classList.remove('active');
            }
        }

        function displayRequests(requests) {
            const container = document.getElementById('requestsContainer');

            if (requests.length === 0) {
                container.innerHTML = '<p class="text-center" style="padding: 2rem;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°</p>';
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</th>
                            <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                            <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${requests.map(request => `
                            <tr>
                                <td><strong>${request.request_number}</strong></td>
                                <td>${request.title}</td>
                                <td>${request.equipment_name}<br><small>${request.equipment_code}</small></td>
                                <td>${request.requester_name || request.requester_username}</td>
                                <td><span class="badge ${getStatusBadge(request.status)}">${request.status_display}</span></td>
                                <td><span class="badge ${getPriorityBadge(request.priority)}">${request.priority_display}</span></td>
                                <td>${formatDate(request.request_date)}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewDetail(${request.id})">‡∏î‡∏π</button>
                                    ${canUpdateStatus(request) ? `<button class="btn btn-sm btn-warning" onclick="openStatusModal(${request.id})">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</button>` : ''}
                                    ${canDelete(request) ? `<button class="btn btn-sm btn-danger" onclick="deleteRequest(${request.id})">‡∏•‡∏ö</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }

        function canUpdateStatus(request) {
            if (!userProfile) return false;
            return userProfile.role === 'admin' || userProfile.role === 'technician';
        }

        function canDelete(request) {
            if (!userProfile) return false;
            const currentUser = getCurrentUser();
            return userProfile.role === 'admin' || 
                   (request.requester === currentUser.id && request.status === 'pending');
        }

        async function viewDetail(id) {
            try {
                const request = await repairAPI.getOne(id);
                const histories = await repairAPI.getHistory(id);

                const modalContent = `
                    <div style="line-height: 1.8;">
                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á:</strong> ${request.request_number}</p>
                        <p><strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</strong> ${request.title}</p>
                        <p><strong>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong> ${request.equipment_name} (${request.equipment_code})</p>
                        <p><strong>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${request.requester_name || request.requester_username}</p>
                        <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong><br>${request.description}</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="badge ${getStatusBadge(request.status)}">${request.status_display}</span></p>
                        <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> <span class="badge ${getPriorityBadge(request.priority)}">${request.priority_display}</span></p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${formatDate(request.request_date)}</p>
                        ${request.assigned_to_name ? `<p><strong>‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</strong> ${request.assigned_to_name}</p>` : ''}
                        ${request.assigned_date ? `<p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢:</strong> ${formatDate(request.assigned_date)}</p>` : ''}
                        ${request.completed_date ? `<p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô:</strong> ${formatDate(request.completed_date)}</p>` : ''}
                        ${request.estimated_cost ? `<p><strong>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${formatCurrency(request.estimated_cost)}</p>` : ''}
                        ${request.actual_cost ? `<p><strong>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á:</strong> ${formatCurrency(request.actual_cost)}</p>` : ''}
                        ${request.remarks ? `<p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${request.remarks}</p>` : ''}
                        
                        <hr>
                        <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</h3>
                        ${histories.length > 0 ? `
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${histories.map(h => `
                                    <div style="padding: 0.75rem; background: #f8fafc; margin-bottom: 0.5rem; border-radius: 4px;">
                                        <p style="margin: 0;"><strong>${h.updated_by_name || h.updated_by_username}</strong> - ${formatDate(h.created_at)}</p>
                                        <p style="margin: 0.25rem 0 0 0;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge ${getStatusBadge(h.status)}">${h.status}</span></p>
                                        ${h.comment ? `<p style="margin: 0.25rem 0 0 0;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô: ${h.comment}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</p>'}
                    </div>
                `;

                document.getElementById('modalContent').innerHTML = modalContent;
                document.getElementById('detailModal').classList.add('active');
            } catch (error) {
                console.error('Error loading detail:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ');
            }
        }

        function openStatusModal(id) {
            document.getElementById('updateRequestId').value = id;
            document.getElementById('statusModal').classList.add('active');
        }

        async function deleteRequest(id) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) {
                return;
            }

            try {
                await repairAPI.delete(id);
                showSuccess('‡∏•‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                loadRequests();
            } catch (error) {
                console.error('Error deleting request:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
            }
        }

        // Handle status update form
        document.getElementById('statusForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('updateRequestId').value;
            const newStatus = document.getElementById('newStatus').value;
            const comment = document.getElementById('statusComment').value;

            try {
                await repairAPI.updateStatus(id, newStatus, comment);
                showSuccess('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                document.getElementById('statusModal').classList.remove('active');
                document.getElementById('statusForm').reset();
                loadRequests();
            } catch (error) {
                console.error('Error updating status:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ');
            }
        });

        // Handle filter button
        document.getElementById('filterBtn').addEventListener('click', () => {
            const filters = {
                search: document.getElementById('searchInput').value,
                status: document.getElementById('statusFilter').value,
                priority: document.getElementById('priorityFilter').value
            };
            loadRequests(filters);
        });

        // Handle reset button
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            loadRequests();
        });

        // Modal close handlers
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('detailModal').classList.remove('active');
        });

        document.getElementById('closeStatusModal').addEventListener('click', () => {
            document.getElementById('statusModal').classList.remove('active');
        });

        document.getElementById('cancelStatusBtn').addEventListener('click', () => {
            document.getElementById('statusModal').classList.remove('active');
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            loadRequests();
        });
    </script>
</body>
</html>